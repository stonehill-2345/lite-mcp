# Docker Compose configuration for LiteMCP
name: litemcp

services:
  # LiteMCP Backend Service
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: litemcp-backend
    ports:
      - "${PROXY_PORT:-1888}:1888"  # Proxy server
      - "${API_PORT:-9000}:9000"  # API server
      # - "8000-8100:8000-8100"  # MCP servers. Generally, proxy(1888) provides unified external services. If it is necessary to expose each mcp server port to external calls, it can be enabled
    environment:
      - PROXY_HOST=${PROXY_HOST:-0.0.0.0}
      - PROXY_PORT=${PROXY_PORT:-1888}
      - API_HOST=${API_HOST:-0.0.0.0}
      - API_PORT=${API_PORT:-9000}
      - MCP_SERVER_HOST=${MCP_SERVER_HOST:-http://127.0.0.1:1888}
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    volumes:
      - litemcp-runtime:/app/runtime
      - litemcp-logs:/app/runtime/logs
      - litemcp-venv:/app/.venv
    networks:
      - backend-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/api/v1/health"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 180s

  # LiteMCP Frontend Service
  frontend:
    build:
      context: ../web
      dockerfile: docker/Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:9000}
        - VITE_PROXY_BASE_URL=${VITE_PROXY_BASE_URL:-http://localhost:1888}
        - VITE_DEBUG_MODE=${VITE_DEBUG_MODE:-false}
    container_name: litemcp-frontend
    ports:
      - "${FRONTEND_PORT:-2345}:80"  # Frontend web server
    depends_on:
      backend:
        condition: service_healthy
    # Note: Backend uses host network, frontend uses bridge network
    # They communicate via localhost since backend binds to 0.0.0.0
    networks:
      - backend-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  backend-network:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.230.0/24
          gateway: 192.168.230.1

volumes:
  litemcp-runtime:
    driver: local
  litemcp-logs:
    driver: local
  litemcp-venv:
    driver: local